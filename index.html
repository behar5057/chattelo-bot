<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chattelo - Random Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #667eea; color: white; text-align: center; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        .logo { font-size: 60px; margin: 20px 0; }
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }
        .btn-primary { background: #4cd964; color: white; }
        .btn-premium { background: #ff6b6b; color: white; }
        .chat-container { display: none; flex-direction: column; height: 100vh; background: white; color: #333; }
        .chat-header { background: #667eea; color: white; padding: 15px; }
        .back-btn { background: none; border: none; color: white; font-size: 18px; cursor: pointer; }
        .messages-container { flex: 1; padding: 15px; overflow-y: auto; }
        .message { max-width: 80%; padding: 10px; margin: 5px 0; border-radius: 10px; }
        .received { background: #e5e5ea; align-self: flex-start; }
        .sent { background: #007aff; color: white; align-self: flex-end; margin-left: auto; }
        .message-input-container { padding: 10px; background: white; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        .message-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; }
        .send-btn { background: #007aff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; }
        .waiting { text-align: center; padding: 30px; color: #666; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .system-msg { text-align: center; color: #666; font-style: italic; margin: 10px 0; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container" id="mainPage">
        <div class="logo">üí¨</div>
        <h1>Chattelo</h1>
        <p>Chat with random people</p>
        
        <button class="btn btn-primary" onclick="startChat()">START CHAT</button>
        <button class="btn btn-premium" onclick="alert('Premium: Contact @ChatteloSupportBot')">PREMIUM</button>
        
        <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 10px;">
            <p><strong>How to test:</strong></p>
            <p>1. Open this page in 2 browser windows</p>
            <p>2. Click START CHAT in both</p>
            <p>3. Wait to connect</p>
            <p>4. Chat!</p>
        </div>
    </div>

    <div class="chat-container" id="chatPage">
        <div class="chat-header">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            <h3 id="status">Finding someone...</h3>
        </div>
        <div class="messages-container" id="messages">
            <div class="waiting">
                <div class="spinner"></div>
                <p>Looking for people...</p>
                <p id="searchText" style="font-size: 12px;">Searching...</p>
            </div>
        </div>
        <div class="message-input-container">
            <input type="text" class="message-input" id="messageInput" placeholder="Type message..." disabled>
            <button class="send-btn" onclick="sendMessage()" disabled>‚û§</button>
        </div>
    </div>

    <script>
        // SIMPLE CHAT SYSTEM
        let userId = null;
        let partnerId = null;
        let roomId = null;
        let isConnected = false;
        let checkInterval = null;

        // Generate unique ID
        function generateId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        }

        // Get data from localStorage
        function getData() {
            return JSON.parse(localStorage.getItem('chattelo') || '{"waiting":[],"rooms":{}}');
        }

        // Save data to localStorage
        function saveData(data) {
            localStorage.setItem('chattelo', JSON.stringify(data));
        }

        // Clean old data
        function cleanOldData() {
            const data = getData();
            const now = Date.now();
            
            // Remove users waiting more than 2 minutes
            data.waiting = data.waiting.filter(user => {
                const userTime = parseInt(user.id.split('_')[1]);
                return now - userTime < 120000; // 2 minutes
            });
            
            // Remove rooms older than 5 minutes
            Object.keys(data.rooms).forEach(roomId => {
                if (now - data.rooms[roomId].created > 300000) {
                    delete data.rooms[roomId];
                }
            });
            
            saveData(data);
        }

        function startChat() {
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('chatPage').style.display = 'flex';
            
            userId = generateId();
            document.getElementById('messages').innerHTML = '<div class="waiting"><div class="spinner"></div><p>Looking for people...</p><p id="searchText" style="font-size: 12px;">Joining chat...</p></div>';
            document.getElementById('messageInput').disabled = true;
            document.querySelector('.send-btn').disabled = true;
            
            cleanOldData();
            joinWaitingList();
            findPartner();
        }

        function joinWaitingList() {
            const data = getData();
            
            // Remove if already waiting
            data.waiting = data.waiting.filter(user => user.id !== userId);
            
            // Add to waiting list
            data.waiting.push({
                id: userId,
                time: Date.now()
            });
            
            saveData(data);
            updateSearchText(`Waiting... (${data.waiting.length} users online)`);
        }

        function findPartner() {
            checkInterval = setInterval(() => {
                const data = getData();
                const waiting = data.waiting || [];
                
                updateSearchText(`Searching... (${waiting.length} users online)`);
                
                // Find partner (not ourselves)
                const partners = waiting.filter(user => user.id !== userId);
                
                if (partners.length > 0) {
                    // Found partner!
                    partnerId = partners[0].id;
                    createRoom();
                }
            }, 2000);
        }

        function createRoom() {
            clearInterval(checkInterval);
            
            const data = getData();
            
            // Remove both from waiting
            data.waiting = data.waiting.filter(user => user.id !== userId && user.id !== partnerId);
            
            // Create room
            roomId = 'room_' + Date.now();
            data.rooms[roomId] = {
                user1: userId,
                user2: partnerId,
                created: Date.now(),
                messages: []
            };
            
            saveData(data);
            startChatSession();
        }

        function startChatSession() {
            isConnected = true;
            document.getElementById('status').textContent = 'Connected!';
            document.getElementById('messages').innerHTML = '';
            showSystemMessage('‚úÖ Connected! Start chatting!');
            
            document.getElementById('messageInput').disabled = false;
            document.querySelector('.send-btn').disabled = false;
            document.getElementById('messageInput').focus();

            // Listen for messages
            listenForMessages();
        }

        function listenForMessages() {
            setInterval(() => {
                if (!isConnected) return;
                
                const data = getData();
                const room = data.rooms[roomId];
                
                if (room && room.messages) {
                    room.messages.forEach(msg => {
                        if (msg.sender === partnerId && !msg.seen) {
                            msg.seen = true;
                            addMessage(msg.text, 'received');
                        }
                    });
                    saveData(data);
                }
            }, 1000);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (text && roomId) {
                // Show my message
                addMessage(text, 'sent');
                
                // Save to room
                const data = getData();
                const room = data.rooms[roomId];
                
                if (room) {
                    room.messages.push({
                        sender: userId,
                        text: text,
                        time: Date.now(),
                        seen: false
                    });
                    saveData(data);
                    input.value = '';
                }
            }
        }

        function addMessage(text, type) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showSystemMessage(text) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'system-msg';
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function updateSearchText(text) {
            const el = document.getElementById('searchText');
            if (el) el.textContent = text;
        }

        function goHome() {
            cleanup();
            document.getElementById('mainPage').style.display = 'block';
            document.getElementById('chatPage').style.display = 'none';
        }

        function cleanup() {
            isConnected = false;
            if (checkInterval) clearInterval(checkInterval);
            
            if (userId) {
                const data = getData();
                data.waiting = data.waiting.filter(user => user.id !== userId);
                saveData(data);
            }
        }

        // Handle Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Auto-clean on load
        window.addEventListener('load', cleanOldData);
    </script>
</body>
</html>
