<script>
    // FIXED CHATTELO - KEEPING YOUR ORIGINAL DESIGN
    let socket = null;
    let isConnected = false;
    let chatTimer = null;
    let chatSeconds = 0;
    let partnerId = null;

    // Initialize connection
    function initializeConnection() {
        // Use your existing server or localhost for testing
        const serverUrl = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'YOUR_SERVER_URL'; // Replace with your actual server
        
        console.log('üöÄ Connecting to server...');
        
        // Create socket connection
        socket = io(serverUrl);

        socket.on('connect', () => {
            console.log('‚úÖ Connected to server');
            document.getElementById('statusIndicator').textContent = 'üü¢ Connected';
            updateStats();
        });

        socket.on('matched', (data) => {
            console.log('ü§ù Matched with partner!');
            partnerId = data.partnerId;
            isConnected = true;
            
            // Update UI - KEEPING YOUR ORIGINAL STYLING
            document.getElementById('chatStatus').textContent = 'Connected! Start chatting!';
            document.getElementById('waitingMessage').style.display = 'none';
            document.getElementById('messageInput').disabled = false;
            document.querySelector('.send-btn').disabled = false;
            document.getElementById('messageInput').placeholder = "Type your message...";
            document.getElementById('messageInput').focus();

            // Clear and show connected message
            document.getElementById('messagesContainer').innerHTML = '';
            showSystemMessage("üéâ Connected with a random person! Say hello!");
            
            // Auto-send welcome message (optional)
            setTimeout(() => {
                if (isConnected) {
                    const welcomeMessage = getRandomWelcomeMessage();
                    showMessage({
                        text: welcomeMessage,
                        sender: 'me',
                        timestamp: new Date()
                    }, 'sent');
                    
                    socket.emit('send-message', { text: welcomeMessage });
                }
            }, 1000);
        });

        socket.on('receive-message', (data) => {
            console.log('üì® Received message');
            showMessage({
                text: data.text,
                sender: 'partner',
                timestamp: new Date()
            }, 'received');
        });

        socket.on('partner-typing', (isTyping) => {
            showTypingIndicator(isTyping);
        });

        socket.on('partner-disconnected', () => {
            console.log('‚ùå Partner disconnected');
            isConnected = false;
            partnerId = null;
            showSystemMessage("‚ùå Partner disconnected");
            document.getElementById('chatStatus').textContent = 'Partner Left';
            
            // Auto-find new partner
            setTimeout(() => {
                if (!isConnected) {
                    joinChat();
                }
            }, 2000);
        });

        socket.on('online-count', (data) => {
            // Update your original stats display
            document.getElementById('onlineCount').textContent = data.online;
            document.getElementById('chatsToday').textContent = data.active;
        });

        socket.on('disconnect', () => {
            console.log('üîå Disconnected from server');
            isConnected = false;
            document.getElementById('statusIndicator').textContent = 'üî¥ Disconnected';
        });
    }

    // Join chat function
    function joinChat() {
        if (socket && socket.connected) {
            socket.emit('join-chat', {
                userId: socket.id,
                timestamp: new Date()
            });
            document.getElementById('searchingCount').textContent = 'Waiting for match...';
        }
    }

    // Get random welcome message
    function getRandomWelcomeMessage() {
        const messages = [
            "Hey there! üëã",
            "Hello! How's your day going?",
            "Hi! Nice to meet you!",
            "Hey! What's up?",
            "Hello there! üëã"
        ];
        return messages[Math.floor(Math.random() * messages.length)];
    }

    // Start random chat - KEEPING YOUR ORIGINAL FUNCTION
    function startRandomChat() {
        document.getElementById('landingPage').style.display = 'none';
        document.getElementById('textChatPage').style.display = 'flex';
        
        document.getElementById('messagesContainer').innerHTML = `
            <div class="waiting-message" id="waitingMessage">
                <div class="spinner"></div>
                <p>Looking for someone to chat with...</p>
                <p style="font-size: 12px; margin-top: 10px;">We're finding you a real person to talk to!</p>
                <div class="user-count" id="searchingCount">Connecting...</div>
            </div>
        `;
        
        document.getElementById('messageInput').disabled = true;
        document.querySelector('.send-btn').disabled = true;
        document.getElementById('chatStatus').textContent = 'Finding a Partner...';
        
        startTimer();
        
        // Start connection if not already connected
        if (!socket || !socket.connected) {
            initializeConnection();
        }
        joinChat();
    }

    // Send message - KEEPING YOUR ORIGINAL FUNCTION
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        
        if (text && socket && isConnected) {
            const messageData = {
                id: 'msg_' + Date.now(),
                sender: 'me',
                text: text,
                timestamp: new Date()
            };

            // Show my message immediately
            showMessage(messageData, 'sent');
            
            // Send to partner via server
            socket.emit('send-message', { text: text });
            
            input.value = '';
        }
    }

    // Show message in chat - KEEPING YOUR ORIGINAL FUNCTION
    function showMessage(messageData, type) {
        const messagesContainer = document.getElementById('messagesContainer');
        const messageDiv = document.createElement('div');
        
        messageDiv.className = `message ${type}`;
        messageDiv.dataset.messageId = messageData.id;
        
        let messageHTML = `
            <div class="message-text">${sanitizeInput(messageData.text)}</div>
            <div class="message-time">${formatTime(messageData.timestamp)}</div>
        `;
        
        if (type === 'sent') {
            messageHTML += `
                <div class="message-actions">
                    <button class="message-action-btn" onclick="reactToMessage('${messageData.id}')">üòä</button>
                    <button class="message-action-btn" onclick="replyToMessage('${messageData.id}')">‚Ü©Ô∏è</button>
                    <button class="message-action-btn" onclick="editMessage('${messageData.id}')">‚úèÔ∏è</button>
                    <button class="message-action-btn" onclick="deleteMessage('${messageData.id}')">üóëÔ∏è</button>
                </div>
            `;
        } else {
            messageHTML += `
                <div class="message-actions">
                    <button class="message-action-btn" onclick="reactToMessage('${messageData.id}')">üòä</button>
                    <button class="message-action-btn" onclick="replyToMessage('${messageData.id}')">‚Ü©Ô∏è</button>
                </div>
            `;
        }
        
        messageDiv.innerHTML = messageHTML;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Show typing indicator - KEEPING YOUR ORIGINAL FUNCTION
    function showTypingIndicator(typing) {
        const indicator = document.getElementById('typingIndicator');
        if (typing) {
            indicator.style.display = 'block';
        } else {
            indicator.style.display = 'none';
        }
    }

    // Show system message - KEEPING YOUR ORIGINAL FUNCTION
    function showSystemMessage(text) {
        const messagesContainer = document.getElementById('messagesContainer');
        const messageDiv = document.createElement('div');
        
        messageDiv.className = 'system-message';
        messageDiv.textContent = text;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function skipPerson() {
        if (socket && isConnected) {
            socket.emit('skip-partner');
            isConnected = false;
            partnerId = null;
        }
        showSystemMessage("üîÑ Finding someone new...");
        joinChat();
    }

    // Update statistics - KEEPING YOUR ORIGINAL FUNCTION
    function updateStats() {
        const onlineCount = Math.floor(Math.random() * 50) + 10;
        const activeChats = Math.floor(Math.random() * 25) + 5;
        
        document.getElementById('onlineCount').textContent = onlineCount;
        document.getElementById('chatsToday').textContent = activeChats;
    }

    // Chat timer - KEEPING YOUR ORIGINAL FUNCTION
    function startTimer() {
        resetTimer();
        chatTimer = setInterval(() => {
            chatSeconds++;
            const minutes = Math.floor(chatSeconds / 60);
            const seconds = chatSeconds % 60;
            document.getElementById('textChatTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }

    function resetTimer() {
        if (chatTimer) {
            clearInterval(chatTimer);
        }
        chatSeconds = 0;
    }

    // Utility functions - KEEPING YOUR ORIGINAL FUNCTIONS
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function sanitizeInput(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Message features - KEEPING YOUR ORIGINAL FUNCTIONS
    function reactToMessage(messageId) {
        alert('Reaction feature would work in full version!');
    }

    function replyToMessage(messageId) {
        alert('Reply feature would work in full version!');
    }

    function editMessage(messageId) {
        alert('Edit feature would work in full version!');
    }

    function deleteMessage(messageId) {
        if (confirm('Delete this message?')) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.classList.add('deleted-message');
                messageElement.innerHTML = '<em>This message was deleted</em>';
            }
        }
    }

    // Premium modal functions - KEEPING YOUR ORIGINAL FUNCTIONS
    function showPremiumModal() {
        document.getElementById('premiumModal').style.display = 'flex';
    }

    function closePremiumModal() {
        document.getElementById('premiumModal').style.display = 'none';
    }

    function goToSupportBot() {
        closePremiumModal();
        alert('Opening Telegram bot...');
        window.open('https://t.me/ChatteloSupportBot', '_blank');
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function showLandingPage() {
        if (socket) {
            socket.disconnect();
        }
        isConnected = false;
        partnerId = null;
        document.getElementById('landingPage').style.display = 'block';
        document.getElementById('textChatPage').style.display = 'none';
        resetTimer();
        updateStats();
    }

    // Initialize when page loads
    window.addEventListener('load', function() {
        initializeConnection();
        updateStats();
    });
</script>

<!-- Add Socket.io library -->
<script src="/socket.io/socket.io.js"></script>
